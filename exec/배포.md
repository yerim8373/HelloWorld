# ë°°í¬

## Docker

- ì´ì „ ë²„ì „ ì œê±°
    
    ```bash
    sudo apt-get remove docker docker-engine docker.io containerd runc
    ```
    
- allow aptÂ to use a repository over HTTPS
    
    ```bash
    sudo apt-get update
    sudo apt-get install \
        ca-certificates \
        curl \
        gnupg \
        lsb-release
    ```
    
- GPG key ì„¤ì •
    
    ```bash
    sudo mkdir -p /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg|
    ```
    
- ë ˆí¬ì§€í† ë¦¬ ì…‹ì—…
    
    ```bash
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    ```
    
- ë„ì»¤ ì„¤ì¹˜
    
    ```bash
    sudo apt-get update
    sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
    ```
    

## ì˜¤í”ˆë¹„ë‘

- ì‚¬ìš©í•  í¬íŠ¸ í™•ì¸
    
    > 80, 443, 3478, 5442, 5443, 8888
    > 
    - ì‹¤í–‰ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸
    
    ```bash
    ps -ef | grep <name>
    ```
    
    - ì‚¬ìš© ì¤‘ì¸ í¬íŠ¸ ë²ˆí˜¸ í™•ì¸
    
    ```bash
    sudo apt-get update
    sudo apt-get install net-tools
    
    sudo netstat -ntlp
    ```
    
    - í”„ë¡œì„¸ìŠ¤ ì œê±°
    
    ```bash
    sudo kill -9 <PID>
    ```
    
- ë°©í™”ë²½ í—ˆìš©
    
    ```bash
    sudo apt-get update
    sudo apt-get install ufw
    
    sudo ufw allow ssl
    sudo ufw allow http
    sudo ufw allow https
    sudo ufw allow 3478/udp
    sudo ufw allow 3478/tcp
    sudo ufw allow 40000:57000/udp
    sudo ufw allow 40000:57000/tcp
    sudo ufw allow 57001:65535/udp
    sudo ufw allow 57001:65535/tcp
    sudo ufw allow enable
    ```
    

- dockerì™€ docker-compose ì„¤ì¹˜ í™•ì¸
- rootê¶Œí•œìœ¼ë¡œ openvidu ì„¤ì¹˜

```bash
cd /opt
sudo su
curl https://s3-eu-west-1.amazonaws.com/aws.openvidu.io/install_openvidu_latest.sh | bash
```

- .env íŒŒì¼ë¡œ í™˜ê²½ ì„¸íŒ…

```bash
cd /openvidu
vi .env
```

```bash
# OpenVidu configuration
# ----------------------
DOMAIN_OR_PUBLIC_IP=

OPENVIDU_SECRET=
# Certificate type:
# - selfsigned:  Self signed certificate. Not recommended for production use.
#                Users will see an ERROR when connected to web page.
# - owncert:     Valid certificate purchased in a Internet services company.
#                Please put the certificates files inside folder ./owncert
#                with names certificate.key and certificate.cert
# - letsencrypt: Generate a new certificate using letsencrypt. Please set the
#                required contact email for Let's Encrypt in LETSENCRYPT_EMAIL
#                variable.
CERTIFICATE_TYPE= 
LETSENCRYPT_EMAIL=
...

HTTP_PORT=80
HTTPS_PORT=443
```

- ì˜¤í”ˆë¹„ë‘ ì‹¤í–‰

```bash
./openvidu start
```

![image1](./deploy/image1.png)

<aside>
ğŸ’¡ letsencrypt certification ìœ„í•´ http : 80, https 443 í¬íŠ¸ë¡œ ìµœì´ˆ ì‹¤í–‰

</aside>

## Nginx

- nginx ì„¤ì¹˜

```bash
sudo apt-get update
sudo apt-get install nginx
```

- https í†µì‹ ì„ ìœ„í•´ ssl/tls ì„¤ì •

```bash
sudo snap install core
sudo snap refresh core
sudo snap install --classic certbot

sudo ln -s /snap/bin/certbot /usr/bin/certbot
sudo certbot --nginx
```

![image2](./deploy/image2.png)

<aside>
ğŸ’¡ certbotì„ í†µí•œ ë¬´ë£Œ letsencryptëŠ” í•œ ë„ë©”ì¸ë‹¹ 1ì£¼ì¼ì— ìµœëŒ€ 5íšŒë§Œ ë°›ì„ ìˆ˜ ìˆìŒ

</aside>

```bash
vi /etc/nginx/sites-available/default
pem key í™•ì¸
```

![image3](./deploy/image3.png)

```bash
sudo service nginx start
```

## ë°±ì—”ë“œ

- ë¹Œë“œí•œ jar íŒŒì¼ ì‹¤í–‰
    
    ```bash
    java -jar <file_name>.jar
    
    -back-ground ì‹¤í–‰
    nohup java -jar <file_name>.jar
    ```
    
- nginx ì„¤ì •
    
    ```bash
    sudo vi /etc/nginx/sites-available/default
    
    server {
    	...
    	server_name example.com;
    	location /api {
    			proxy_pass http://localhost:8080/api;
    	}
    	...
    }
    ```
    
    ```bash
    sudo nginx -t
    sudo service nginx restart
    ```
    

## í”„ë¡ íŠ¸ì—”ë“œ

- nginx ì„¤ì •
    
    ```bash
    sudo vi /etc/nginx/sites-available/default
    
    server {
    	...
    	server_name example.com;
    	location / {
    			proxy_pass http://localhost:3000;
    	}
    
    	location /api {
    			proxy_pass http://localhost:8080/api;
    	}
    	...
    }
    ```
    
    ```bash
    sudo nginx -t
    sudo service nginx restart
    ```
    
- Dockerfile
    
    ```bash
    í”„ë¡œì íŠ¸ ìµœìƒë‹¨ì— Dockerfile ë§Œë“¤ê¸°
    vi Dockerfile
    ```
    
    ```bash
    FROM nginx
    
    RUN mkdir /app
    
    WORKDIR /app
    
    RUN mkdir ./build
    
    ADD ./build ./build
    
    RUN rm /etc/nginx/conf.d/default.conf
    
    COPY ./nginx.conf /etc/nginx/conf.d
    
    EXPOSE 80
    
    CMD ["nginx", "-g", "daemon off;"]
    ```
    
- nginx.conf íŒŒì¼ ì¶”ê°€ ì œì‘
    
    ```bash
    DockerfileìˆëŠ”ê³³ì— nginx.conf ë§Œë“¤ê¸°
    
    vi nginx.config
    ```
    
    ```bash
    server {
    	listen 80;
    	server_name example.com;
    	
    	location / {
    		root /app/build;
    		index index.html;
    		try_files $uri $uri/ /index.html;
    	}
    }
    ```
    
- ë¹Œë“œ í”„ë¡œì íŠ¸
    
    ```bash
    npm install
    npm run build
    ```
    
- ë„ì»¤ ì´ë¯¸ì§€í™” & ì‹¤í–‰
    
    ```bash
    sudo docker login
    sudo docker build -t <ë„ì»¤ ì•„ì´ë””>/<ì´ë¯¸ì§€ëª…>:<ë²„ì „>
    sudo docker push <ë„ì»¤ ì•„ì´ë””>/<ì´ë¯¸ì§€ëª…>:<ë²„ì „>
    
    sudo docker pull <ë„ì»¤ ì•„ì´ë””>/<ì´ë¯¸ì§€ëª…>:<ë²„ì „>
    sudo docker run -d --name <name> -p 3000:80 <ë„ì»¤ ì•„ì´ë””>/<ì´ë¯¸ì§€ëª…>:<ë²„ì „>
    ```
    
    <aside>
    ğŸ’¡ í‘¸ì‰¬ ì „ docker hubì— ê°€ì„œ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì´ë¯¸ì§€ ëª…ê³¼ ë™ì¼í•˜ê²Œ ë§Œë“¤ì–´ ì¤˜ì•¼ í•¨
    
    </aside>
    

## DB with Docker

- Mysql ì„¤ì¹˜ & ì‹¤í–‰
    
    ```bash
    sudo docker pull mysql:latest
    sudo docker run -d --name <name> -e MYSQL_ROOT_PASSWORD=<password> -p 3306:3306 mysql:latest
    ```
    
- Mysql db ìƒì„±
    
    ```bash
    sudo docker exec -it <name> /bin/bash
    
    mysql -u root -p
    
    create database IF NOT EXISTS `db_name` collate utf8mb4_general_ci;
    ```
    
- Mysql User ìƒì„± & ê¶Œí•œ ë¶€ì—¬
    
    ```bash
    create user 'ì‚¬ìš©ìê³„ì •'@'localhost' identified by 'ë¹„ë°€ë²ˆí˜¸';
    grant all privileges on <db_name>.* to 'ì‚¬ìš©ìê³„ì •'@'localhost';
    flush privileges;
    ```
    
    <aside>
    ğŸ’¡ [localhost](http://localhost) ëŒ€ì‹  %ì‚¬ìš©í•˜ì—¬ ì™¸ë¶€ì—ì„œ ì ‘ê·¼ í—ˆìš©
    
    </aside>
    

- Redis ì„¤ì¹˜ & ì‹¤í–‰
    
    ```bash
    sudo docker pull redis
    docker run -d --name <name> -p 6378:6378 redis
    ```